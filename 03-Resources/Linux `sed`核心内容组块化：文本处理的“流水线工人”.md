
朋友，在Linux的命令行世界里，如果你需要对文本进行**非交互式**的批量处理、转换、替换、删除等操作，那么`sed`就是你的得力干将！

它不像`vi`或`nano`那样需要你打开文件手动编辑，而是像一个“流水线工人”，默默地、高效地处理着每一行文本数据。你给它一套“操作手册”（`sed`脚本），它就严格按照手册上的指令，一行一行地对数据进行加工，然后把加工好的产品（处理后的文本）输出。

下面，咱们就一块一块地把这个“流水线工人”的用法和核心功能搞明白：

## 1. `sed`是什么？—— 你的文本“流水线工人”

- **定义**: `sed`是一个流编辑器，它从文件或标准输入中读取文本行，然后根据预设的脚本命令对这些行进行处理（如查找、替换、删除、插入等），并将结果输出到标准输出。
    
- **核心特点**: **非交互式**、**逐行处理**、**基于模式匹配**。
    
- **类比**: 如果把文本数据比作工厂里的原材料，`sed`就是那条自动化生产线。你告诉它“遇到A就换成B，遇到C就删除”，它就会自动地、高效地完成这些任务，无需你手动干预。
    

## 2. `sed`的基本用法：启动你的“流水线”

`sed`的基本语法结构是这样的：

```
sed [选项] '地址 定位符 命令' 文件名
```

或者：

```
sed [选项] -f 脚本文件 文件名
```

- **`地址 定位符` (Address)**: 告诉`sed`对哪些行进行操作。如果没有指定，则对所有行进行操作。
    
- **`命令` (Command)**: 你要对匹配的行执行什么操作（如替换、删除、打印等）。
    
- **`文件`**: 你要处理的输入文件。如果省略，`sed`会从标准输入读取。
    
- **例子1：最简单的替换**
    
    - 将`myfile.txt`中每行出现的第一个“old”替换为“new”：
        
        ```
        sed 's/old/new/' myfile.txt
        ```
        
        （注意：默认只替换每行第一个匹配项）
        
- **例子2：从标准输入读取**
    
    - 从`ls -l`的输出中，删除所有包含“total”的行：
        
        ```
        ls -l | sed '/total/d'
        ```
        

## 3. 核心概念：`sed`的“操作对象”—— 地址（Address）

`sed`的强大之处在于它能精确地选择要操作的行。你可以通过以下方式指定“地址”：

- **无地址**: 对所有行执行命令。
    
    - **例子**：`sed 's/a/b/' file.txt` (替换所有行中的第一个'a'为'b')
        
- **单行号**: 对指定行号的行执行命令。
    
    - **例子**：`sed '5d' file.txt` (删除第5行)
        
    - **例子**：`sed '3s/old/new/' file.txt` (只在第3行进行替换)
        
- **行号范围**: 对指定行号范围内的行执行命令（包含起始和结束行）。
    
    - **例子**：`sed '5,10d' file.txt` (删除第5到第10行)
        
    - **例子**：`sed '1,3s/old/new/g' file.txt` (在第1到第3行进行全局替换)
        
- **模式匹配**: 对匹配指定模式的行执行命令。
    
    - **例子**：`sed '/Error/d' log.txt` (删除所有包含“Error”的行)
        
    - **例子**：`sed '/^WARN/s/WARN/WARNING/' log.txt` (将以“WARN”开头的行中的“WARN”替换为“WARNING”)
        
- **模式范围**: 对匹配第一个模式的行到匹配第二个模式的行之间的所有行执行命令。
    
    - **例子**：`sed '/start/,/end/d' file.txt` (删除从包含“start”的行到包含“end”的行之间的所有行)
        

## 4. 核心概念：`sed`的“操作指令”—— 命令（Commands）

`sed`提供了多种命令来处理选定的行。

- **`p` (print)**: **打印**匹配的行。
    
    - **注意**：`sed`默认会打印所有行。如果只想打印匹配的行，通常需要结合`-n`选项（禁止默认输出）。
        
    - **例子**：`sed -n '/Error/p' log.txt` (只打印包含“Error”的行)
        
- **`d` (delete)**: **删除**匹配的行。
    
    - **例子**：`sed '/^#/d' config.txt` (删除所有以`#`开头的注释行)
        
- **`s` (substitute)**: **替换**。这是`sed`最常用、最强大的命令。
    
    - 语法：`s/正则表达式/替换字符串/标志`
        
    - **例子**：`sed 's/foo/bar/g' file.txt` (将所有`foo`替换为`bar`，`g`表示全局替换)
        
    - **详细讲解见下一节。**
        
- **`a` (append)**: **在匹配行之后追加文本**。
    
    - **例子**：`sed '/Error/a\--- End of Error Block ---' log.txt` (在每行“Error”之后追加一行文本)
        
    - 注意：追加的文本需要换行，通常用`\`来表示换行。
        
- **`i` (insert)**: **在匹配行之前插入文本**。
    
    - **例子**：`sed '/Error/i\--- Start of Error Block ---' log.txt` (在每行“Error”之前插入一行文本)
        
- **`c` (change)**: **用新文本替换匹配的行**。
    
    - **例子**：`sed '/old_line/c\new_line_content' file.txt` (将包含“old_line”的行替换为“new_line_content”)
        
- **`=` (print line number)**: **打印匹配行的行号**。
    
    - **例子**：`sed -n '/Error/=' log.txt` (只打印包含“Error”的行号)
        

## 5. `sed`的“核心武器”—— 替换命令 `s`

`s`命令是`sed`的灵魂，它允许你使用正则表达式进行复杂的查找和替换。

- **基本语法**: `s/正则表达式/替换字符串/标志`
    
- **`正则表达式`**: 你要查找的模式（可以使用上一节介绍的正则表达式）。
    
- **`替换字符串`**: 你要替换成的内容。
    
    - **`&`**: 代表匹配到的整个字符串。
        
        - **例子**：`sed 's/foo/(&)/' file.txt` (将`foo`替换为`(foo)`)
            
    - **`\n` (反向引用)**: 引用正则表达式中捕获的组（`()`）。
        
        - **例子**：`sed 's/\([0-9]\{3\}\)-\([0-9]\{4\}\)/\2-\1/' phone.txt` (将`123-4567`替换为`4567-123`)
            
- **`标志` (Flags)**: 控制替换行为。
    
    - `g` (global): **全局替换**。替换一行中所有匹配的项，而不是第一个。
        
        - **例子**：`sed 's/a/b/g' file.txt` (将所有`a`替换为`b`)
            
    - `i` (ignore-case): **忽略大小写**。
        
        - **例子**：`sed 's/error/BUG/gi' log.txt` (不区分大小写地将所有“error”替换为“BUG”)
            
    - `p` (print): **打印**发生替换的行。通常与`-n`结合使用。
        
        - **例子**：`sed -n 's/old/new/p' file.txt` (只打印发生替换的行)
            
    - `w file` (write): 将发生替换的行**写入**到指定文件。
        
        - **例子**：`sed 's/error/bug/w errors.log' log.txt` (替换错误，并将发生替换的行写入`errors.log`)
            
    - `NUM`: 替换一行中第`NUM`个匹配项。
        
        - **例子**：`sed 's/a/b/2' file.txt` (替换每行中第二个`a`为`b`)
            
- **分隔符**: 除了`/`，你也可以使用其他字符作为分隔符，当你模式或替换字符串中包含`/`时，这会很有用。
    
    - **例子**：将`/usr/local`替换为`/opt`：
        
        ```
        sed 's#/usr/local#/opt#g' path.txt
        ```
        

## 6. `sed`的“原地编辑”：直接修改文件

默认情况下，`sed`会将处理结果输出到标准输出，而不会修改原文件。如果你想直接修改文件，可以使用`-i`选项。

- **`-i` (in-place)**: **直接修改文件**。
    
    - **例子**：将`file.txt`中所有`old`替换为`new`，并直接保存到原文件：
        
        ```
        sed -i 's/old/new/g' file.txt
        ```
        
    - **`-i.bak`**: 创建一个备份文件。在修改原文件之前，会先创建一个以`.bak`为后缀的备份文件。
        
        - **例子**：`sed -i.bak 's/old/new/g' file.txt` (修改`file.txt`，并创建`file.txt.bak`作为备份)
            
        - **注意**：使用`-i`时务必小心，因为它会直接修改文件，不可逆！
            

## 7. `sed`的“组合操作”：多条命令

你可以为`sed`提供多条命令，它会按顺序逐一执行。

- **多条命令用分号`;`分隔**：
    
    - **例子**：先删除空行，再将`foo`替换为`bar`：
        
        ```
        sed '/^$/d; s/foo/bar/g' file.txt
        ```
        
- **使用`-e`选项指定多条命令**：
    
    - **例子**：
        
        ```
        sed -e '/^$/d' -e 's/foo/bar/g' file.txt
        ```
        
- **使用脚本文件（`-f`选项）**：
    
    - 将所有`sed`命令写入一个文本文件（例如`script.sed`），每行一条命令。
        
    - `script.sed`内容：
        
        ```
        /^$/d
        s/foo/bar/g
        ```
        
    - 执行命令：
        
        ```
        sed -f script.sed file.txt
        ```
        
    - 这对于复杂的、可复用的`sed`操作非常有用。
        

## 8. 常见`sed`应用场景：日常“流水线”案例

- **删除空行**:
    
    ```
    sed '/^$/d' file.txt
    ```
    
- **删除注释行**:
    
    ```
    sed '/^#/d' config.txt
    ```
    
- **在指定行插入内容**:
    
    - 在第3行前插入“Hello World”：
        
        ```
        sed '3i\Hello World' file.txt
        ```
        
- **替换文件中的所有特定字符串**:
    
    ```
    sed 's/old_string/new_string/g' file.txt
    ```
    
- **删除文件中的特定行范围**:
    
    ```
    sed '10,20d' file.txt # 删除第10到20行
    sed '/start_pattern/,/end_pattern/d' file.txt # 删除从start_pattern到end_pattern的行
    ```
    
- **提取日志中的特定信息**:
    
    - 提取所有包含“user_id:”的行，并只保留ID：
        
        ```
        grep "user_id:" log.txt | sed 's/.*user_id:\([0-9]*\).*/\1/'
        ```
        

## 总结与“流水线工人”心得

`sed`是Linux命令行中处理文本数据的强大工具，尤其擅长批量、非交互式的文本转换。

- **核心口诀**: `sed [选项] '地址 定位符 命令' 文件`
    
- **记住三大要素**: **地址**（操作哪几行）、**命令**（做什么操作）、**选项**（如何操作）。
    
- **`s`命令是王道**: 掌握替换命令`s`及其标志和反向引用，你就掌握了`sed`的精髓。
    
- **`-i`要小心**: 直接修改文件时务必谨慎，最好先备份或在测试文件上操作。
    
- **与正则表达式结合**: `sed`的模式匹配能力完全依赖于正则表达式，掌握正则表达式是玩转`sed`的前提。
    

熟练掌握`sed`，你就能像一个高效的“流水线工人”一样，轻松完成各种复杂的文本处理任务！去吧，去自动化你的文本处理流程！